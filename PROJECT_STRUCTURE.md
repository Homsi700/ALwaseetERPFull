
# تقرير هيكل وتفاصيل المشروع

## 1. مقدمة

هذا المستند يوفر نظرة شاملة على هيكل مشروع "نظام الوسيط لإدارة نقاط البيع والمخزون". الهدف منه هو أن يكون مرجعاً أساسياً للمطورين وفريق الصيانة لفهم بنية الكود، تدفق البيانات، والتقنيات المستخدمة.

**التقنيات الأساسية:**

*   **الواجهة الأمامية (Frontend):** Next.js (with App Router), React, TypeScript
*   **الواجهة الرسومية (UI):** ShadCN UI Components, Tailwind CSS
*   **قاعدة البيانات والخدمات الخلفية (Backend/BaaS):** Supabase (Authentication, Database, Storage)
*   **وظائف الذكاء الاصطناعي (AI):** Google AI (Gemini) via Genkit

---

## 2. هيكل المجلدات الرئيسي

```
.
├── src
│   ├── app                 # صفحات ومسارات المشروع (Next.js App Router)
│   │   ├── (page-name)     # مجلد لكل صفحة رئيسية (e.g., dashboard, products)
│   │   │   └── page.tsx    # المكون الرئيسي للصفحة
│   │   ├── layout.tsx      # الهيكل الرئيسي للتطبيق (Root Layout)
│   │   ├── page.tsx        # صفحة الدخول الرئيسية
│   │   └── globals.css     # الأنماط العامة و متغيرات ألوان ShadCN/Tailwind
│   │
│   ├── components          # مكونات React القابلة لإعادة الاستخدام
│   │   ├── ui              # مكونات ShadCN الأساسية (Button, Card, etc.)
│   │   ├── auth            # مكونات المصادقة (e.g., LoginForm)
│   │   ├── layout          # مكون هيكل التطبيق الرئيسي (AppLayout)
│   │   └── products        # مكونات خاصة بالمنتجات (ProductTable, ProductFormModal)
│   │
│   ├── contexts            # React Contexts لإدارة الحالة العامة
│   │   └── AuthContext.tsx # لإدارة حالة المستخدم والمصادقة واسم الشركة
│   │
│   ├── hooks               # Hooks مخصصة
│   │   ├── useAuth.ts      # Hook للوصول السهل إلى AuthContext
│   │   ├── useToast.ts     # Hook لعرض الإشعارات (Toasts)
│   │   └── use-mobile.ts   # Hook للتحقق من عرض الجوال
│   │
│   ├── lib                 # وظائف مساعدة وتهيئة المكتبات
│   │   ├── supabaseClient.ts # تهيئة وإعداد عميل Supabase
│   │   └── utils.ts        # وظائف مساعدة عامة (e.g., cn for classnames)
│   │
│   └── ai                  # وظائف الذكاء الاصطناعي (Genkit)
│       ├── genkit.ts       # إعداد وتهيئة Genkit
│       └── flows           # مجلد يحتوي على تدفقات عمل Genkit
│
├── public/                 # الملفات العامة (صور، أيقونات)
├── .env                    # متغيرات البيئة (Supabase keys)
├── next.config.ts          # إعدادات Next.js
├── tailwind.config.ts      # إعدادات Tailwind CSS
├── components.json         # إعدادات ShadCN
└── database_schema_report.md # تقرير تفصيلي لهيكل قاعدة البيانات
└── PROJECT_STRUCTURE.md    # هذا الملف
```

---

## 3. الأقسام الرئيسية والمنطق البرمجي

### أ. المصادقة (Authentication)

*   تتم إدارة المصادقة بالكامل عبر **Supabase Auth**.
*   يتم استخدام **`AuthContext`** (`src/contexts/AuthContext.tsx`) لتوفير معلومات المستخدم الحالي (`user`) وجلسة الدخول (`session`) لجميع مكونات التطبيق.
*   يقوم `AuthContext` بمراقبة تغييرات حالة المصادقة (تسجيل الدخول/الخروج) وتوجيه المستخدم تلقائياً بين صفحة الدخول (`/`) ولوحة التحكم (`/dashboard`).
*   **اسم الشركة المركزي (`companyName`)** تتم إدارته أيضاً عبر `AuthContext` ويتم حفظه في `localStorage` لضمان استمراريته.

### ب. تدفق البيانات (Data Flow)

*   يتم جلب جميع البيانات (منتجات، عملاء، فواتير، إلخ) مباشرة من قاعدة بيانات **Supabase**.
*   يتم استخدام العميل الموحد **`supabase`** من `src/lib/supabaseClient.ts` في جميع صفحات المشروع لإجراء عمليات (SELECT, INSERT, UPDATE, DELETE).
*   في كل صفحة تتعامل مع بيانات (e.g., `products/page.tsx`, `clients/page.tsx`), يتم استخدام دوال **`mapToSupabase...`** و **`mapFromSupabase...`** لتحويل البيانات بين هيكل الواجهة الأمامية (TypeScript interfaces) وهيكل قاعدة البيانات (أسماء الأعمدة في Supabase). هذا يوفر طبقة من التنظيم ويسهل التعامل مع البيانات.

### ج. إدارة الحالة (State Management)

*   يتم إدارة معظم حالات الواجهة (مثل فتح/إغلاق النماذج، قيم حقول البحث) بشكل محلي داخل كل مكون باستخدام React Hooks (`useState`, `useCallback`, etc.).
*   تستخدم **`AuthContext`** للحالات العامة التي تحتاجها معظم أجزاء التطبيق (معلومات المستخدم، اسم الشركة).
*   يستخدم **`useToast`** لإدارة عرض الإشعارات بشكل مركزي ومنظم.

### د. التصميم والواجهة الرسومية (Styling & UI)

*   يعتمد النظام بشكل أساسي على مكتبة **ShadCN UI** التي توفر مكونات واجهة رسومية جاهزة وقابلة للتخصيص.
*   يتم استخدام **Tailwind CSS** للتصميم المخصص.
*   يتم تعريف الألوان الأساسية للمشروع كمتغيرات CSS في `src/app/globals.css`، مما يسهل تغيير المظهر العام للنظام من مكان واحد.

### هـ. وظائف الذكاء الاصطناعي (AI Functionality)

*   يستخدم المشروع مكتبة **Genkit** للتكامل مع نماذج الذكاء الاصطناعي من Google (Gemini).
*   يتم تعريف تدفقات العمل (Flows) في مجلد `src/ai/flows`. حالياً، يوجد تدفق `financial-report-assistant` الذي يمكنه تحليل وشرح النصوص المالية.

---

## 4. التكامل مع قاعدة البيانات

*   للحصول على تفاصيل كاملة حول الجداول، الأعمدة، والعلاقات، يرجى مراجعة ملف **`database_schema_report.md`**.
*   يجب التأكد من أن متغيرات البيئة (`NEXT_PUBLIC_SUPABASE_URL` و `NEXT_PUBLIC_SUPABASE_ANON_KEY`) معرفة بشكل صحيح في ملف `.env`.
*   يجب تطبيق **سياسات أمان على مستوى الصفوف (RLS - Row Level Security)** على جميع الجداول في Supabase لضمان أمان البيانات. الكود الحالي يفترض أن RLS مفعلة وأن المستخدم لديه الصلاحيات اللازمة.
*   **Supabase Views:** للحصول على أداء أفضل في التقارير المعقدة، تم استخدام Views في قاعدة البيانات (مثل `gross_profit_per_product_view`). يجب إنشاؤها في Supabase لتعمل التقارير بشكل صحيح.

---

## 5. ملاحظات هامة للصيانة والتطوير المستقبلي

*   **إدارة المستخدمين المتقدمة:** عمليات إنشاء المستخدمين وتعيين الأدوار من الواجهة الأمامية تتطلب وظائف خلفية آمنة (Supabase Edge Functions) لضمان عدم تعريض صلاحيات الإدارة للخطر. الواجهات الحالية في قسم "المستخدمين" هي للعرض والتوضيح.
*   **الطباعة:** تكامل الطباعة المباشرة (خاصة مع الطابعات الحرارية) هو ميزة متقدمة تتطلب مكتبات إضافية ومنطقاً برمجياً متخصصاً يتجاوز واجهة الويب التقليدية.
*   **تحديد مسار التصدير:** لا يمكن لتطبيقات الويب تحديد مسار حفظ الملفات مباشرة (مثل "سطح المكتب"). المتصفح هو الذي يتحكم في هذه العملية، وعادةً ما يحفظ الملفات في مجلد "التنزيلات".
*   **الإعدادات الدائمة:** العديد من الخيارات في قسم "الإعدادات" (مثل العملة، الضرائب، معلومات العنوان) هي حالياً تغييرات واجهة فقط. لحفظها بشكل دائم في قاعدة البيانات، يجب إنشاء جداول مخصصة لها.

    